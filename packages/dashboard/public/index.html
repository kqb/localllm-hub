<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LocalLLM Hub ‚Äî Dashboard</title>
<style>
  :root {
    --bg: #0d1117; --bg2: #161b22; --bg3: #21262d; --border: #30363d;
    --text: #e6edf3; --text2: #8b949e; --accent: #58a6ff; --green: #3fb950;
    --red: #f85149; --yellow: #d29922; --purple: #bc8cff; --orange: #f0883e;
    --radius: 8px; --shadow: 0 1px 3px rgba(0,0,0,.3);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
  header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; gap: 16px; }
  header h1 { font-size: 20px; font-weight: 600; }
  header h1 span { color: var(--accent); }
  .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
  .status-dot.ok { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.err { background: var(--red); box-shadow: 0 0 6px var(--red); }
  .status-dot.warn { background: var(--yellow); }
  header .meta { margin-left: auto; color: var(--text2); font-size: 13px; }

  main { max-width: 1400px; margin: 0 auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; }

  .grid { display: grid; gap: 16px; }
  .grid-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
  .grid-3 { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
  .grid-6 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }

  .card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
  .card h2 { font-size: 14px; text-transform: uppercase; letter-spacing: .5px; color: var(--text2); margin-bottom: 12px; }
  .card h3 { font-size: 16px; font-weight: 600; margin-bottom: 8px; }

  .stat { display: flex; flex-direction: column; gap: 4px; }
  .stat .label { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; }
  .stat .value { font-size: 24px; font-weight: 700; font-variant-numeric: tabular-nums; }
  .stat .value.sm { font-size: 16px; }

  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .badge.green { background: rgba(63,185,80,.15); color: var(--green); }
  .badge.red { background: rgba(248,81,73,.15); color: var(--red); }
  .badge.yellow { background: rgba(210,153,34,.15); color: var(--yellow); }
  .badge.blue { background: rgba(88,166,255,.15); color: var(--accent); }
  .badge.purple { background: rgba(188,140,255,.15); color: var(--purple); }
  .badge.orange { background: rgba(240,136,62,.15); color: var(--orange); }

  .kv { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
  .kv:last-child { border-bottom: none; }
  .kv .k { color: var(--text2); }

  /* Search */
  .search-box { display: flex; gap: 8px; margin-bottom: 12px; }
  .search-box input[type=text] { flex: 1; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 14px; color: var(--text); font-size: 14px; outline: none; }
  .search-box input:focus { border-color: var(--accent); }
  .search-box button, .btn { background: var(--accent); color: #000; border: none; border-radius: var(--radius); padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }
  .btn:hover { opacity: .85; }
  .btn.sm { padding: 4px 10px; font-size: 12px; }
  .btn.outline { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
  .btn.outline:hover { background: rgba(88,166,255,.1); }
  .btn.danger { background: var(--red); color: #fff; }

  .filters { display: flex; gap: 16px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
  .filters label { display: flex; align-items: center; gap: 4px; font-size: 13px; color: var(--text2); cursor: pointer; }
  .filters input[type=checkbox] { accent-color: var(--accent); }
  .filters .range-wrap { display: flex; align-items: center; gap: 8px; }
  .filters input[type=range] { width: 100px; accent-color: var(--accent); }

  .results { display: flex; flex-direction: column; gap: 8px; max-height: 500px; overflow-y: auto; }
  .result-item { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; cursor: pointer; transition: border-color .15s; }
  .result-item:hover { border-color: var(--accent); }
  .result-item .meta { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; font-size: 12px; }
  .result-item .score { color: var(--green); font-weight: 700; font-variant-numeric: tabular-nums; }
  .result-item .preview { color: var(--text2); font-size: 13px; line-height: 1.4; overflow: hidden; }
  .result-item .preview.expanded { max-height: none !important; }
  .result-item .preview:not(.expanded) { max-height: 60px; }

  /* Model cards */
  .model-row { display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .model-row:last-child { border-bottom: none; }
  .model-row .name { font-weight: 600; font-size: 14px; flex: 1; }
  .model-row .size { color: var(--text2); font-size: 13px; }

  /* Package cards */
  .pkg-card { display: flex; flex-direction: column; gap: 8px; }
  .pkg-card .pkg-header { display: flex; align-items: center; gap: 8px; }
  .pkg-card .pkg-name { font-weight: 600; font-size: 15px; }
  .pkg-card .pkg-ver { font-size: 12px; color: var(--text2); }

  /* Jobs */
  .job-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }

  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--text2); font-size: 13px; display: flex; align-items: center; gap: 8px; }

  .empty { color: var(--text2); font-size: 14px; text-align: center; padding: 24px; }

  /* Context Monitor */
  .ctx-progress { position: relative; height: 28px; background: var(--bg3); border-radius: 4px; overflow: hidden; }
  .ctx-progress-fill { height: 100%; border-radius: 4px; transition: width .4s ease; }
  .ctx-progress-fill.green { background: var(--green); opacity: .7; }
  .ctx-progress-fill.yellow { background: var(--yellow); opacity: .7; }
  .ctx-progress-fill.red { background: var(--red); opacity: .7; }
  .ctx-progress-label { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; color: var(--text); text-shadow: 0 1px 2px rgba(0,0,0,.5); }
  .ctx-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .ctx-table th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--text2); padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .ctx-table td { padding: 5px 8px; border-bottom: 1px solid var(--border); }
  .ctx-table tr:last-child td { border-bottom: none; }
  .ctx-table .missing { color: var(--text2); font-style: italic; }
  .ctx-table .num { text-align: right; font-variant-numeric: tabular-nums; }

  /* Conversation */
  #chat-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
  #chat-controls select { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 6px 10px; color: var(--text); font-size: 13px; min-width: 200px; }
  .chat-toggle { padding: 4px 12px; border-radius: 12px; border: 1px solid var(--border); background: transparent; color: var(--text2); cursor: pointer; font-size: 12px; transition: all .15s; }
  .chat-toggle.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  #chat-messages { max-height: 600px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; padding: 8px 0; }
  .chat-msg { padding: 10px 14px; border-radius: 8px; font-size: 14px; line-height: 1.6; }
  .chat-msg.user { background: var(--bg3); border-left: 3px solid var(--green); }
  .chat-msg.assistant { background: var(--bg2); border-left: 3px solid var(--accent); }
  .chat-msg.tool-result-msg { background: var(--bg2); border-left: 3px solid var(--yellow); font-size: 12px; }
  .chat-msg .msg-role { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; color: var(--text2); margin-bottom: 4px; }
  .chat-msg .msg-text { white-space: pre-wrap; word-break: break-word; }
  .chat-msg .msg-text code { background: var(--bg3); padding: 1px 4px; border-radius: 3px; font-size: 13px; }
  .chat-msg .msg-text pre { background: #1a1a2e; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; margin: 8px 0; }
  .chat-msg .timestamp { font-size: 11px; color: var(--text2); margin-top: 4px; }
  .chat-thinking { background: rgba(128,0,255,.08); border-left: 2px solid #8b5cf6; padding: 8px 10px; margin: 6px 0; font-style: italic; color: #a78bfa; font-size: 13px; border-radius: 4px; cursor: pointer; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
  .chat-thinking.collapsed { max-height: 24px; overflow: hidden; }
  .chat-thinking-label { font-weight: 600; font-size: 11px; margin-bottom: 4px; display: block; }
  .chat-tool-call { display: inline-flex; align-items: center; gap: 4px; background: rgba(88,166,255,.15); color: var(--accent); padding: 3px 8px; border-radius: 12px; font-size: 12px; font-family: monospace; margin: 4px 2px; cursor: pointer; }
  .chat-tool-args { background: #1a1a2e; color: #e0e0e0; padding: 8px; border-radius: 4px; font-size: 11px; font-family: monospace; margin: 4px 0; white-space: pre-wrap; max-height: 150px; overflow-y: auto; display: none; }
  .chat-tool-result-content { background: var(--bg3); padding: 8px; border-radius: 4px; font-size: 12px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; word-break: break-word; }
  .chat-tool-result-content.error { border-left: 2px solid var(--red); }
  .chat-usage { font-size: 11px; color: var(--text2); margin-top: 4px; }
  .chat-hidden { display: none !important; }

  /* Agent Monitor */
  .agent-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .agent-table th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--text2); padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .agent-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .agent-table tr:last-child td { border-bottom: none; }
  .agent-table tr.clickable { cursor: pointer; transition: background .15s; }
  .agent-table tr.clickable:hover { background: var(--bg3); }
  .agent-table tr.selected { background: rgba(88,166,255,.08); }
  .agent-status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .agent-status-dot.active { background: var(--green); box-shadow: 0 0 4px var(--green); }
  .agent-status-dot.idle { background: var(--yellow); }
  .agent-status-dot.stale { background: var(--red); }
  .agent-output { background: #1a1a2e; color: #e0e0e0; font-family: monospace; font-size: 12px; padding: 12px; border-radius: 4px; overflow-y: auto; max-height: 400px; line-height: 1.6; margin-top: 12px; white-space: pre-wrap; word-break: break-word; }
  .agent-input-bar { display: flex; gap: 8px; margin-top: 8px; }
  .agent-input-bar input[type=text] { flex: 1; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 14px; color: var(--text); font-size: 14px; outline: none; }
  .agent-input-bar input:focus { border-color: var(--accent); }

  /* Budget bar */
  .budget-bar { position: relative; height: 36px; background: var(--bg3); border-radius: 4px; overflow: hidden; display: flex; }
  .budget-seg { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,.6); overflow: hidden; white-space: nowrap; transition: width .4s ease; }
  .budget-legend { display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px; margin-top: 8px; }
  .budget-legend span { display: flex; align-items: center; gap: 4px; }
  .budget-legend .swatch { width: 12px; height: 12px; border-radius: 2px; display: inline-block; }

  /* Model manager table */
  .mm-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .mm-table th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--text2); padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .mm-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .mm-table tr:last-child td { border-bottom: none; }
  .mm-table .actions { display: flex; gap: 4px; }

  /* Route tiers table */
  .tier-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 16px; }
  .tier-table th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--text2); padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .tier-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .tier-table tr:last-child td { border-bottom: none; }

  /* RAG chunk list */
  .rag-chunk { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; margin-bottom: 6px; }
  .rag-chunk .rag-meta { font-size: 12px; color: var(--text2); margin-bottom: 4px; display: flex; gap: 8px; }
  .rag-chunk .rag-text { font-size: 13px; color: var(--text); max-height: 60px; overflow: hidden; cursor: pointer; white-space: pre-wrap; }
  .rag-chunk .rag-text.expanded { max-height: none; }

  /* Prompt Editor */
  .pe-select { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 12px; color: var(--text); font-size: 14px; min-width: 200px; }
  .pe-textarea { width: 100%; min-height: 400px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; color: var(--text); font-family: 'SF Mono', 'Menlo', 'Monaco', monospace; font-size: 13px; line-height: 1.5; resize: vertical; outline: none; margin-top: 8px; }
  .pe-textarea:focus { border-color: var(--accent); }
  .pe-bar { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
  .pe-stats { font-size: 12px; color: var(--text2); flex: 1; }

  /* Skills grid */
  .skills-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
  .skill-card { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; cursor: pointer; transition: border-color .15s; }
  .skill-card:hover { border-color: var(--accent); }
  .skill-card .skill-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .skill-card .skill-name { font-weight: 600; font-size: 14px; }
  .skill-card .skill-desc { font-size: 13px; color: var(--text2); line-height: 1.4; }
  .skill-detail { background: #1a1a2e; padding: 12px; border-radius: 4px; font-size: 13px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; margin-top: 8px; display: none; }

  /* Corrections */
  .correction-item { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 14px; cursor: pointer; transition: border-color .15s; margin-bottom: 6px; }
  .correction-item:hover { border-color: var(--accent); }
  .correction-item .corr-header { display: flex; align-items: center; gap: 8px; font-size: 13px; }
  .correction-item .corr-name { font-weight: 600; flex: 1; }
  .correction-item .corr-body { font-size: 13px; color: var(--text2); white-space: pre-wrap; margin-top: 8px; max-height: 300px; overflow-y: auto; display: none; }

  /* Session Manager table */
  .sess-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .sess-table th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--text2); padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .sess-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .sess-table tr:last-child td { border-bottom: none; }
  .sess-table .sess-id { font-family: monospace; font-size: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .sess-table .clickable { cursor: pointer; color: var(--accent); }
  .sess-table .clickable:hover { text-decoration: underline; }

  /* Cron table */
  .cron-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .cron-table th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--text2); padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .cron-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .cron-table tr:last-child td { border-bottom: none; }

  /* Alerts */
  .alert-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-bottom: 1px solid var(--border); }
  .alert-item:last-child { border-bottom: none; }
  .alert-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .alert-dot.green { background: var(--green); }
  .alert-dot.yellow { background: var(--yellow); }
  .alert-dot.red { background: var(--red); box-shadow: 0 0 6px var(--red); }
  .alert-title { font-weight: 600; font-size: 14px; }
  .alert-detail { font-size: 13px; color: var(--text2); margin-left: auto; }

  @media (max-width: 768px) {
    main { padding: 12px; }
    .grid-2, .grid-3, .grid-6 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <h1>üß† <span>LocalLLM</span> Hub</h1>
  <span id="ollama-dot" class="status-dot warn" title="Checking..."></span>
  <span id="ollama-label" style="font-size:13px;color:var(--text2)">Checking Ollama...</span>
  <div class="meta">
    <span id="last-update">‚Äî</span>
  </div>
</header>

<main>
  <!-- Status Row -->
  <section class="grid grid-2">
    <div class="card" id="status-card">
      <h2>‚ö° Service Status</h2>
      <div id="status-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
    </div>
    <div class="card" id="models-card">
      <h2>ü§ñ Loaded Models</h2>
      <div id="models-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
    </div>
  </section>

  <!-- Context Monitor -->
  <section class="card" id="context-card">
    <h2>üìä Context Monitor</h2>
    <div id="context-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Agent Monitor -->
  <section class="card" id="agents-card">
    <h2>ü§ñ Agent Monitor</h2>
    <div id="agents-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Conversation -->
  <section class="card" id="chat-card">
    <h2>üí¨ Conversation</h2>
    <div id="chat-controls">
      <select id="chat-session-select"><option value="">Select session...</option></select>
      <button class="chat-toggle active" id="chat-toggle-thinking" onclick="toggleChat('thinking')">üß† Thinking</button>
      <button class="chat-toggle active" id="chat-toggle-tools" onclick="toggleChat('tools')">üîß Tools</button>
      <button class="chat-toggle" id="chat-toggle-usage" onclick="toggleChat('usage')">üìä Usage</button>
    </div>
    <div id="chat-load-more" style="text-align:center;display:none"><button class="btn" onclick="loadMoreChat()">Load More ‚Üë</button></div>
    <div id="chat-messages"></div>
  </section>

  <!-- Search -->
  <section class="card" id="search-card">
    <h2>üîç Semantic Search</h2>
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Search memory, chats, and Telegram..." />
      <button class="btn" onclick="doSearch()">Search</button>
    </div>
    <div class="filters">
      <label><input type="checkbox" id="src-memory" checked> üìù Memory</label>
      <label><input type="checkbox" id="src-chat" checked> üí¨ Chat</label>
      <label><input type="checkbox" id="src-telegram" checked> üì± Telegram</label>
      <div class="range-wrap">
        <span style="font-size:13px;color:var(--text2)">Top-K:</span>
        <input type="range" id="topk" min="1" max="20" value="5">
        <span id="topk-val" style="font-size:13px;color:var(--text);min-width:20px">5</span>
      </div>
    </div>
    <div id="search-results" class="results"></div>
  </section>

  <!-- Jobs & Packages Row -->
  <section class="grid grid-2">
    <div class="card" id="jobs-card">
      <h2>üìä Ingestion Stats</h2>
      <div id="jobs-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn sm outline" onclick="triggerReindex()">üîÑ Reindex Memory</button>
        <button class="btn sm outline" onclick="loadJobs()">‚Üª Refresh</button>
      </div>
    </div>
    <div class="card">
      <h2>üìã Operation Log</h2>
      <div id="op-log" style="max-height:200px;overflow-y:auto;font-size:13px;color:var(--text2)">
        <div class="empty">No operations yet</div>
      </div>
    </div>
  </section>

  <!-- Clawdbot Behavior -->
  <section class="card" id="clawdbot-card">
    <h2>ü§ñ Clawdbot Memory Behavior</h2>
    <div id="clawdbot-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Memory Config -->
  <section class="card" id="memory-card">
    <h2>üß† Memory Configuration</h2>
    <div id="memory-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Daemons -->
  <section class="card" id="daemons-card">
    <h2>üîÑ Daemons</h2>
    <div id="daemons-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Packages -->
  <section class="card">
    <h2>üì¶ Packages</h2>
    <div id="packages-grid" class="grid grid-6">
      <span class="loading-text"><span class="spinner"></span> Loading...</span>
    </div>
  </section>

  <!-- Model Manager -->
  <section class="card" id="model-mgr-card">
    <h2>üóÇÔ∏è Model Manager</h2>
    <div id="model-mgr-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Model Budget Visualizer -->
  <section class="card" id="budget-card">
    <h2>üíæ Model Budget Visualizer</h2>
    <div id="budget-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Route Switcher -->
  <section class="card" id="routes-card">
    <h2>üö¶ Route Switcher</h2>
    <div id="routes-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- RAG Inspector -->
  <section class="card" id="rag-card">
    <h2>üî¨ RAG Inspector</h2>
    <div id="rag-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Token Economics -->
  <section class="card" id="economics-card">
    <h2>üí∞ Token Economics</h2>
    <div id="economics-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Prompt Editor -->
  <section class="card" id="prompt-editor-card">
    <h2>üìù Prompt Editor</h2>
    <div id="prompt-editor-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Skills Manager -->
  <section class="card" id="skills-card">
    <h2>üß© Skills Manager</h2>
    <div id="skills-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Corrections Viewer -->
  <section class="card" id="corrections-card">
    <h2>üîß Corrections Viewer</h2>
    <div id="corrections-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Session Manager -->
  <section class="card" id="sessions-card">
    <h2>üìÇ Session Manager</h2>
    <div id="sessions-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Cron Manager -->
  <section class="card" id="cron-card">
    <h2>‚è∞ Cron Manager</h2>
    <div id="cron-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>

  <!-- Alerts -->
  <section class="card" id="alerts-card">
    <h2>üö® Alerts</h2>
    <div id="alerts-content"><span class="loading-text"><span class="spinner"></span> Loading...</span></div>
  </section>
</main>

<script>
const API = '';
const $  = id => document.getElementById(id);

// --- Helpers ---
function fmt(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

function fmtModelSize(bytes) {
  if (!bytes) return '?';
  return (bytes / 1073741824).toFixed(1) + ' GB';
}

function logOp(msg) {
  const el = $('op-log');
  const ts = new Date().toLocaleTimeString();
  const div = document.createElement('div');
  div.style.padding = '4px 0';
  div.style.borderBottom = '1px solid var(--border)';
  div.innerHTML = `<span style="color:var(--text2)">[${ts}]</span> ${msg}`;
  if (el.querySelector('.empty')) el.innerHTML = '';
  el.prepend(div);
}

// --- Status ---
async function loadStatus() {
  try {
    const res = await fetch(API + '/api/status');
    const d = await res.json();

    // Header dot
    const dot = $('ollama-dot');
    const lbl = $('ollama-label');
    if (d.ollama.healthy) {
      dot.className = 'status-dot ok'; lbl.textContent = 'Ollama Online';
    } else {
      dot.className = 'status-dot err'; lbl.textContent = 'Ollama Offline';
    }
    $('last-update').textContent = 'Updated ' + new Date(d.timestamp).toLocaleTimeString();

    // Status card
    let html = '';
    html += `<div class="kv"><span class="k">Ollama</span><span class="badge ${d.ollama.healthy ? 'green' : 'red'}">${d.ollama.healthy ? 'Healthy' : 'Down'}</span></div>`;
    html += `<div class="kv"><span class="k">whisper.cpp</span><span class="badge ${d.whisper.found ? 'green' : 'yellow'}">${d.whisper.found ? 'Found' : 'Not Found'}</span></div>`;
    if (d.whisper.path) html += `<div class="kv"><span class="k">Whisper Path</span><span style="font-size:12px;color:var(--text2)">${d.whisper.path}</span></div>`;
    for (const db of d.databases) {
      const badge = db.exists ? (db.error ? 'yellow' : 'green') : 'red';
      const label = db.exists ? (db.error ? 'Error' : 'OK') : 'Missing';
      html += `<div class="kv"><span class="k">${db.label}</span><span class="badge ${badge}">${label}</span></div>`;
      if (db.sizeBytes) html += `<div class="kv"><span class="k" style="padding-left:12px">Size</span><span>${fmt(db.sizeBytes)}</span></div>`;
      if (db.tables) {
        for (const [t, c] of Object.entries(db.tables)) {
          html += `<div class="kv"><span class="k" style="padding-left:12px">${t}</span><span>${c.toLocaleString()} rows</span></div>`;
        }
      }
    }
    $('status-content').innerHTML = html;
  } catch (e) {
    $('ollama-dot').className = 'status-dot err';
    $('ollama-label').textContent = 'Dashboard API Error';
    $('status-content').innerHTML = `<div class="empty" style="color:var(--red)">Error: ${e.message}</div>`;
  }
}

// --- Models ---
async function loadModels() {
  try {
    const res = await fetch(API + '/api/models');
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    const models = d.models || [];
    if (!models.length) {
      $('models-content').innerHTML = '<div class="empty">No models loaded</div>';
      return;
    }
    let html = '';
    for (const m of models) {
      html += `<div class="model-row">
        <span class="name">${m.name}</span>
        <span class="size">${fmtModelSize(m.size)}</span>
        <span class="badge blue">${m.details?.family || '‚Äî'}</span>
      </div>`;
    }
    $('models-content').innerHTML = html;
  } catch (e) {
    $('models-content').innerHTML = `<div class="empty" style="color:var(--red)">${e.message}</div>`;
  }
}

// --- Context Monitor ---
async function loadContextMonitor() {
  try {
    const res = await fetch(API + '/api/context-monitor');
    const d = await res.json();
    const s = d.session || {};
    const parts = [];

    // 1. Context window progress bar
    if (s.error) {
      parts.push('<div style="margin-bottom:16px">');
      parts.push('<div style="font-size:13px;color:var(--text2);margin-bottom:8px">' + escHtml(s.error) + '</div>');
      parts.push('<div class="ctx-progress"><div class="ctx-progress-fill green" style="width:0%"></div><div class="ctx-progress-label">No session data</div></div>');
      parts.push('</div>');
    } else {
      const pct = Math.round(s.percentUsed || 0);
      const colorClass = pct < 60 ? 'green' : pct < 80 ? 'yellow' : 'red';
      const totalK = (s.totalTokens / 1000).toFixed(0);
      const ctxK = (s.contextTokens / 1000).toFixed(0);
      parts.push('<div style="margin-bottom:16px">');
      parts.push('<div class="ctx-progress">');
      parts.push('<div class="ctx-progress-fill ' + colorClass + '" style="width:' + pct + '%"></div>');
      parts.push('<div class="ctx-progress-label">' + ctxK + 'k / ' + totalK + 'k tokens (' + pct + '%)</div>');
      parts.push('</div>');
      if (pct >= 80) {
        parts.push('<div style="margin-top:6px;font-size:12px;color:var(--red);font-weight:600">Warning: Context window critically full ‚Äî compaction imminent</div>');
      } else if (pct >= 60) {
        parts.push('<div style="margin-top:6px;font-size:12px;color:var(--yellow)">Context window filling up</div>');
      }
      parts.push('</div>');
    }

    // 2. Session info
    if (!s.error) {
      parts.push('<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:16px">');
      parts.push('<div class="kv"><span class="k">Model</span><span class="badge blue">' + escHtml(s.model) + '</span></div>');
      parts.push('<div class="kv"><span class="k">Input Tokens</span><span>' + (s.inputTokens || 0).toLocaleString() + '</span></div>');
      parts.push('<div class="kv"><span class="k">Output Tokens</span><span>' + (s.outputTokens || 0).toLocaleString() + '</span></div>');
      parts.push('<div class="kv"><span class="k">Remaining</span><span>' + (s.remainingTokens || 0).toLocaleString() + '</span></div>');
      parts.push('</div>');
    }

    // 3. Injected files table
    parts.push('<h3 style="margin-bottom:8px">Injected Files</h3>');
    parts.push('<table class="ctx-table"><thead><tr><th>File</th><th class="num">Size</th><th class="num">Est. Tokens</th></tr></thead><tbody>');
    for (const f of d.injectedFiles || []) {
      if (f.missing) {
        parts.push('<tr><td class="missing">' + escHtml(f.name) + '</td><td class="num missing">‚Äî</td><td class="num missing">‚Äî</td></tr>');
      } else {
        parts.push('<tr><td>' + escHtml(f.name) + '</td><td class="num">' + fmt(f.bytes) + '</td><td class="num">' + f.estTokens.toLocaleString() + '</td></tr>');
      }
    }
    const t = d.injectedTotal || {};
    parts.push('<tr style="font-weight:600"><td>Total</td><td class="num">' + fmt(t.bytes || 0) + '</td><td class="num">' + (t.estTokens || 0).toLocaleString() + '</td></tr>');
    parts.push('</tbody></table>');

    // 4. Memory footprint
    const m = d.memory || {};
    parts.push('<h3 style="margin-top:16px;margin-bottom:8px">Memory Footprint</h3>');
    parts.push('<div style="background:var(--bg3);border-radius:var(--radius);padding:12px">');
    parts.push('<div class="kv"><span class="k">Daily Memory Files</span><span>' + (m.dailyFiles || 0) + ' .md files</span></div>');
    if (m.memoryMd) {
      parts.push('<div class="kv"><span class="k">MEMORY.md</span><span>' + m.memoryMd.lines + ' lines ¬∑ ' + fmt(m.memoryMd.bytes) + '</span></div>');
    } else {
      parts.push('<div class="kv"><span class="k">MEMORY.md</span><span style="color:var(--text2)">Not found</span></div>');
    }
    if (m.todayLog) {
      parts.push('<div class="kv"><span class="k">Today\'s Log</span><span>' + fmt(m.todayLog.bytes) + '</span></div>');
    } else {
      parts.push('<div class="kv"><span class="k">Today\'s Log</span><span style="color:var(--text2)">No entries yet</span></div>');
    }
    parts.push('</div>');

    // NOTE: This dashboard is an internal-only admin tool served on localhost.
    // All data comes from local system commands (clawdbot status) and local file reads.
    // No user-supplied or external content is rendered ‚Äî escHtml is used for defense in depth.
    $('context-content').innerHTML = parts.join('');
  } catch (e) {
    $('context-content').textContent = 'Error: ' + e.message;
  }
}

// --- Conversation ---
let _chatState = { sessionId: null, offset: 0, total: 0, messages: [], showThinking: true, showTools: true, showUsage: false, tailInterval: null };

async function loadChatSessions() {
  try {
    const res = await fetch(API + '/api/chat/sessions');
    const sessions = await res.json();
    const sel = $('chat-session-select');
    sel.innerHTML = '<option value="">Select session...</option>';
    for (const s of sessions) {
      const opt = document.createElement('option');
      opt.value = s.sessionId;
      const date = new Date(s.lastModified).toLocaleString();
      const size = s.sizeBytes > 1048576 ? (s.sizeBytes / 1048576).toFixed(1) + 'MB' : (s.sizeBytes / 1024).toFixed(0) + 'KB';
      opt.textContent = s.sessionId.slice(0, 8) + '... (' + size + ', ' + date + ')';
      sel.appendChild(opt);
    }
    sel.onchange = () => {
      const sid = sel.value;
      if (sid) { _chatState.sessionId = sid; _chatState.offset = 0; _chatState.messages = []; loadChatMessages(true); startChatTail(); }
      else { _chatState.sessionId = null; stopChatTail(); $('chat-messages').innerHTML = ''; }
    };
    // Auto-select first (most recent)
    if (sessions.length && !_chatState.sessionId) {
      sel.value = sessions[0].sessionId;
      sel.onchange();
    }
  } catch (e) {
    console.error('loadChatSessions error:', e);
  }
}

async function loadChatMessages(initial) {
  if (!_chatState.sessionId) return;
  try {
    const res = await fetch(API + '/api/chat/' + _chatState.sessionId + '/messages?limit=50&offset=' + _chatState.offset);
    const d = await res.json();
    _chatState.total = d.total;
    const container = $('chat-messages');

    if (initial) {
      container.innerHTML = '';
      _chatState.messages = d.messages;
    } else {
      _chatState.messages = [...d.messages, ..._chatState.messages];
    }

    renderChatMessages(container, initial ? d.messages : d.messages, initial);
    $('chat-load-more').style.display = d.hasMore ? 'block' : 'none';
    if (initial) container.scrollTop = container.scrollHeight;
  } catch (e) {
    $('chat-messages').textContent = 'Error: ' + e.message;
  }
}

function loadMoreChat() {
  _chatState.offset += 50;
  const container = $('chat-messages');
  const oldHeight = container.scrollHeight;
  loadChatMessages(false).then(() => {
    container.scrollTop = container.scrollHeight - oldHeight;
  });
}

function renderChatMessages(container, messages, append) {
  const frag = document.createDocumentFragment();
  for (const msg of messages) {
    frag.appendChild(renderChatMsg(msg));
  }
  if (append) container.appendChild(frag);
  else container.insertBefore(frag, container.firstChild);
}

function renderChatMsg(msg) {
  const div = document.createElement('div');
  const role = msg.role || 'unknown';

  if (role === 'toolResult') {
    div.className = 'chat-msg tool-result-msg' + (_chatState.showTools ? '' : ' chat-hidden');
    div.dataset.type = 'tool';
    const label = document.createElement('div');
    label.className = 'msg-role';
    label.textContent = 'üîß ' + (msg.toolResult?.toolName || 'tool result');
    div.appendChild(label);
    if (msg.toolResult) {
      const content = document.createElement('div');
      content.className = 'chat-tool-result-content' + (msg.toolResult.isError ? ' error' : '');
      const text = msg.toolResult.content || '';
      content.textContent = text.length > 500 ? text.slice(0, 500) + '...' : text;
      if (text.length > 500) {
        content.style.cursor = 'pointer';
        content.onclick = () => { content.textContent = content.textContent.length < text.length ? text : text.slice(0, 500) + '...'; };
      }
      div.appendChild(content);
    }
    addTimestamp(div, msg);
    return div;
  }

  div.className = 'chat-msg ' + role;

  // Role label
  const roleLabel = document.createElement('div');
  roleLabel.className = 'msg-role';
  roleLabel.textContent = role === 'user' ? 'üë§ User' : 'ü§ñ Assistant' + (msg.model ? ' ¬∑ ' + msg.model : '');
  div.appendChild(roleLabel);

  // Thinking
  if (msg.thinking) {
    const thinkDiv = document.createElement('div');
    thinkDiv.className = 'chat-thinking collapsed' + (_chatState.showThinking ? '' : ' chat-hidden');
    thinkDiv.dataset.type = 'thinking';
    const label = document.createElement('span');
    label.className = 'chat-thinking-label';
    label.textContent = 'üß† Thinking (click to expand)';
    thinkDiv.appendChild(label);
    const content = document.createElement('div');
    content.textContent = msg.thinking;
    thinkDiv.appendChild(content);
    thinkDiv.onclick = () => {
      thinkDiv.classList.toggle('collapsed');
      label.textContent = thinkDiv.classList.contains('collapsed') ? 'üß† Thinking (click to expand)' : 'üß† Thinking';
    };
    div.appendChild(thinkDiv);
  }

  // Text
  if (msg.text) {
    const textDiv = document.createElement('div');
    textDiv.className = 'msg-text';
    textDiv.innerHTML = renderMarkdown(escHtml(msg.text));
    div.appendChild(textDiv);
  }

  // Tool calls
  if (msg.toolCalls && msg.toolCalls.length) {
    const toolsDiv = document.createElement('div');
    toolsDiv.dataset.type = 'tool';
    if (!_chatState.showTools) toolsDiv.classList.add('chat-hidden');
    for (const tc of msg.toolCalls) {
      const badge = document.createElement('span');
      badge.className = 'chat-tool-call';
      badge.textContent = 'üîß ' + (tc.name || 'tool');
      const argsDiv = document.createElement('div');
      argsDiv.className = 'chat-tool-args';
      argsDiv.textContent = typeof tc.arguments === 'string' ? tc.arguments : JSON.stringify(tc.arguments, null, 2);
      badge.onclick = () => { argsDiv.style.display = argsDiv.style.display === 'none' ? 'block' : 'none'; };
      toolsDiv.appendChild(badge);
      toolsDiv.appendChild(argsDiv);
    }
    div.appendChild(toolsDiv);
  }

  // Usage
  if (msg.usage) {
    const usageDiv = document.createElement('div');
    usageDiv.className = 'chat-usage' + (_chatState.showUsage ? '' : ' chat-hidden');
    usageDiv.dataset.type = 'usage';
    usageDiv.textContent = '‚Üì ' + (msg.usage.input || 0).toLocaleString() + ' in ¬∑ ‚Üë ' + (msg.usage.output || 0).toLocaleString() + ' out';
    div.appendChild(usageDiv);
  }

  addTimestamp(div, msg);
  return div;
}

function addTimestamp(div, msg) {
  if (msg.timestamp) {
    const ts = document.createElement('div');
    ts.className = 'timestamp';
    ts.textContent = new Date(msg.timestamp).toLocaleString();
    div.appendChild(ts);
  }
}

function renderMarkdown(html) {
  // Code blocks
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Bold
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  // Newlines (outside pre)
  html = html.replace(/\n/g, '<br>');
  return html;
}

function toggleChat(type) {
  const btn = $('chat-toggle-' + type);
  const active = btn.classList.toggle('active');
  if (type === 'thinking') _chatState.showThinking = active;
  else if (type === 'tools') _chatState.showTools = active;
  else if (type === 'usage') _chatState.showUsage = active;

  // Toggle visibility via CSS
  document.querySelectorAll('#chat-messages [data-type="' + type + '"]').forEach(el => {
    el.classList.toggle('chat-hidden', !active);
  });
}

function startChatTail() {
  stopChatTail();
  _chatState.tailInterval = setInterval(async () => {
    if (!_chatState.sessionId) return;
    try {
      const res = await fetch(API + '/api/chat/' + _chatState.sessionId + '/messages/stream?last=5');
      const d = await res.json();
      if (d.total > _chatState.total) {
        const newCount = d.total - _chatState.total;
        const newMsgs = d.messages.slice(-newCount);
        _chatState.total = d.total;
        _chatState.messages.push(...newMsgs);
        const container = $('chat-messages');
        const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
        renderChatMessages(container, newMsgs, true);
        if (wasAtBottom) container.scrollTop = container.scrollHeight;
      }
    } catch { /* ignore tail errors */ }
  }, 5000);
}

function stopChatTail() {
  if (_chatState.tailInterval) { clearInterval(_chatState.tailInterval); _chatState.tailInterval = null; }
}

// --- Search ---
$('topk').addEventListener('input', () => $('topk-val').textContent = $('topk').value);
$('search-input').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

async function doSearch() {
  const q = $('search-input').value.trim();
  if (!q) return;
  const sources = [];
  if ($('src-memory').checked) sources.push('memory');
  if ($('src-chat').checked) sources.push('chat');
  if ($('src-telegram').checked) sources.push('telegram');
  const topK = $('topk').value;

  $('search-results').innerHTML = '<span class="loading-text"><span class="spinner"></span> Searching...</span>';
  logOp(`Search: "${q}" [${sources.join(',')}] top-${topK}`);

  try {
    const res = await fetch(`${API}/api/search?q=${encodeURIComponent(q)}&sources=${sources.join(',')}&topK=${topK}`);
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    if (!d.results?.length) {
      $('search-results').innerHTML = '<div class="empty">No results found</div>';
      return;
    }
    let html = '';
    for (const r of d.results) {
      const srcMap = { memory: ['üìù', 'purple'], chat: ['üí¨', 'blue'], telegram: ['üì±', 'orange'] };
      const [icon, color] = srcMap[r.source] || ['‚ùì', 'yellow'];
      const meta = r.meta || {};
      let detail = '';
      if (r.source === 'memory') detail = `${meta.file || ''}:${meta.startLine || ''}`;
      else if (r.source === 'chat') detail = meta.sessionId ? `session:${meta.sessionId.slice(0,8)}` : '';
      else detail = meta.startTs ? new Date(meta.startTs).toLocaleString() : '';

      html += `<div class="result-item" onclick="this.querySelector('.preview').classList.toggle('expanded')">
        <div class="meta">
          <span class="score">${r.score.toFixed(3)}</span>
          <span class="badge ${color}">${icon} ${r.source}</span>
          <span style="color:var(--text2)">${detail}</span>
        </div>
        <div class="preview">${escHtml(r.text)}</div>
      </div>`;
    }
    $('search-results').innerHTML = html;
    logOp(`Found ${d.results.length} results for "${q}"`);
  } catch (e) {
    $('search-results').innerHTML = `<div class="empty" style="color:var(--red)">Error: ${e.message}</div>`;
    logOp(`Search error: ${e.message}`);
  }
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

// --- Jobs ---
async function loadJobs() {
  try {
    const res = await fetch(API + '/api/jobs');
    const d = await res.json();
    if (!d.hasData) {
      $('jobs-content').innerHTML = '<div class="empty">No ingestion data yet. Run <code>localllm chat ingest</code></div>';
      return;
    }
    let html = '<div class="job-grid">';
    if (d.filesIndexed != null) html += `<div class="stat"><span class="label">Files Indexed</span><span class="value">${d.filesIndexed}</span></div>`;
    if (d.chatSessions != null) html += `<div class="stat"><span class="label">Chat Sessions</span><span class="value">${d.chatSessions}</span></div>`;
    if (d.chatChunks != null) html += `<div class="stat"><span class="label">Chat Chunks</span><span class="value">${d.chatChunks.toLocaleString()}</span></div>`;
    if (d.telegramChunks != null) html += `<div class="stat"><span class="label">Telegram Chunks</span><span class="value">${d.telegramChunks.toLocaleString()}</span></div>`;
    html += '</div>';
    if (d.lastUpdate) html += `<div style="margin-top:8px;font-size:12px;color:var(--text2)">Last update: ${d.lastUpdate}</div>`;
    $('jobs-content').innerHTML = html;
  } catch (e) {
    $('jobs-content').innerHTML = `<div class="empty" style="color:var(--red)">${e.message}</div>`;
  }
}

async function triggerReindex() {
  logOp('Reindex started...');
  try {
    const res = await fetch(API + '/api/reindex', { method: 'POST' });
    const d = await res.json();
    logOp(`Reindex triggered: source=${d.source}`);
  } catch (e) {
    logOp(`Reindex error: ${e.message}`);
  }
}

// --- Clawdbot Behavior ---
async function loadClawdbot() {
  try {
    const res = await fetch(API + '/api/clawdbot/config');
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    const mem = d.memorySearch || {};
    const comp = d.compaction || {};
    const flush = comp.memoryFlush || {};

    let html = '<div class="grid grid-2" style="gap:16px">';

    // Left: Memory Search
    html += '<div>';
    html += '<h3 style="margin-bottom:10px">üîç Memory Search</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    html += cfgToggle('Enabled', 'cb-mem-enabled', mem.enabled !== false);
    html += cfgRow('Provider', 'cb-mem-provider', mem.provider || 'openai', 'text');
    html += cfgRow('Model', 'cb-mem-model', mem.model || '', 'text');
    html += cfgRow('Fallback', 'cb-mem-fallback', mem.fallback || 'local', 'text');
    html += cfgRow('Sources', 'cb-mem-sources', (mem.sources || []).join(', '), 'text');
    html += '</div>';

    html += '<h3 style="margin-bottom:10px">üåê Remote Embedding</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    const remote = mem.remote || {};
    html += cfgRow('Base URL', 'cb-mem-url', remote.baseUrl || '', 'text');
    html += cfgRow('API Key', 'cb-mem-apikey', remote.apiKey || '', 'text');
    html += '</div>';

    html += '<h3 style="margin-bottom:10px">‚ö° Features</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    html += cfgToggle('Vector Store', 'cb-mem-vector', mem.store?.vector?.enabled !== false);
    html += cfgToggle('Hybrid Query', 'cb-mem-hybrid', mem.query?.hybrid?.enabled !== false);
    html += cfgToggle('Cache', 'cb-mem-cache', mem.cache?.enabled !== false);
    html += cfgToggle('Watch Sync', 'cb-mem-watch', mem.sync?.watch !== false);
    html += cfgToggle('Session Memory', 'cb-mem-session', mem.experimental?.sessionMemory === true);
    html += '</div>';
    html += '</div>';

    // Right: Compaction
    html += '<div>';
    html += '<h3 style="margin-bottom:10px">üì¶ Compaction</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    html += cfgToggle('Memory Flush', 'cb-comp-flush', flush.enabled !== false);
    html += `<div style="font-size:12px;color:var(--text2);margin-top:4px">Flush trigger & reserve are controlled by sliders below ‚Üì</div>`;
    html += '</div>';

    html += '<h3 style="margin-bottom:10px">üí¨ Flush Prompts</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    html += `<div style="margin-bottom:8px"><label style="font-size:12px;color:var(--text2);display:block;margin-bottom:4px">User Prompt</label>
      <textarea id="cb-comp-prompt" rows="3" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px;color:var(--text);font-size:12px;resize:vertical;outline:none;font-family:inherit"
      onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">${escHtml(flush.prompt || '')}</textarea></div>`;
    html += `<div><label style="font-size:12px;color:var(--text2);display:block;margin-bottom:4px">System Prompt</label>
      <textarea id="cb-comp-sysprompt" rows="3" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px;color:var(--text);font-size:12px;resize:vertical;outline:none;font-family:inherit"
      onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">${escHtml(flush.systemPrompt || '')}</textarea></div>`;
    html += '</div>';

    // Model & Flush Tuning
    html += '<h3 style="margin-bottom:10px">üéõÔ∏è Model & Flush Tuning</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';

    const MODELS = {
      'anthropic/claude-opus-4-5':   { label: 'Claude Opus 4.5',   ctx: 200000, out: 32000 },
      'anthropic/claude-sonnet-4-5': { label: 'Claude Sonnet 4.5', ctx: 200000, out: 16384 },
      'anthropic/claude-sonnet-4-20250514': { label: 'Claude Sonnet 4', ctx: 200000, out: 16384 },
      'anthropic/claude-haiku-3-5':  { label: 'Claude Haiku 3.5',  ctx: 200000, out: 8192 },
    };

    const currentModel = d.model?.primary || 'anthropic/claude-opus-4-5';
    const currentSpec = MODELS[currentModel] || { ctx: 200000, out: 32000 };

    html += `<div class="kv" style="align-items:center"><span class="k">Primary Model</span>
      <select id="cb-model" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;color:var(--text);font-size:13px;outline:none"
        onchange="updateFlushSliders()">`;
    for (const [id, spec] of Object.entries(MODELS)) {
      html += `<option value="${id}" ${id === currentModel ? 'selected' : ''}>${spec.label} (${(spec.ctx/1000)}K ctx)</option>`;
    }
    html += `</select></div>`;

    html += `<div class="kv"><span class="k">Workspace</span><span style="font-size:12px">${d.workspace || '?'}</span></div>`;
    html += `<div class="kv"><span class="k">Thinking</span><span>${d.thinkingDefault || 'off'}</span></div>`;

    // Context visualization
    html += `<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">`;
    html += `<div style="font-size:12px;color:var(--text2);margin-bottom:8px">Context Budget</div>`;
    html += `<div id="ctx-bar" style="position:relative;height:28px;background:var(--bg);border-radius:4px;overflow:hidden;margin-bottom:4px"></div>`;
    html += `<div id="ctx-legend" style="font-size:11px;color:var(--text2)"></div>`;
    html += `</div>`;

    // Flush threshold slider
    const flushVal = comp.memoryFlush?.softThresholdTokens || 160000;
    html += `<div style="margin-top:12px"><label style="font-size:12px;color:var(--text2)">Flush Trigger</label>
      <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
        <input type="range" id="cb-flush-slider" min="50" max="95" value="${Math.round(flushVal/currentSpec.ctx*100)}"
          style="flex:1;accent-color:var(--accent)" oninput="updateFlushDisplay()">
        <span id="cb-flush-pct" style="font-size:14px;font-weight:600;min-width:40px;text-align:right">${Math.round(flushVal/currentSpec.ctx*100)}%</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-top:2px">
        <span>50% (conservative)</span><span>95% (aggressive)</span>
      </div>
      <div id="cb-flush-tokens" style="font-size:12px;color:var(--text2);margin-top:4px">${flushVal.toLocaleString()} tokens</div>
    </div>`;

    // Reserve floor slider
    const reserveVal = comp.reserveTokensFloor || 30000;
    html += `<div style="margin-top:12px"><label style="font-size:12px;color:var(--text2)">Reserve Floor (for flush writes)</label>
      <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
        <input type="range" id="cb-reserve-slider" min="10000" max="50000" step="5000" value="${reserveVal}"
          style="flex:1;accent-color:var(--yellow)" oninput="updateFlushDisplay()">
        <span id="cb-reserve-val" style="font-size:14px;font-weight:600;min-width:60px;text-align:right">${(reserveVal/1000).toFixed(0)}K</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-top:2px">
        <span>10K (minimal)</span><span>50K (generous)</span>
      </div>
    </div>`;

    html += '</div>';

    html += '</div>';
    html += '</div>';

    // Save button
    html += `<div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" onclick="saveClawdbot()">üíæ Save & Apply</button>
      <span id="cb-save-status" style="font-size:13px;color:var(--text2);align-self:center"></span>
    </div>`;

    $('clawdbot-content').innerHTML = html;
    // Render context bar after DOM is ready
    setTimeout(updateFlushDisplay, 50);
  } catch (e) {
    $('clawdbot-content').innerHTML = `<div class="empty" style="color:var(--red)">${e.message}</div>`;
  }
}

function cfgToggle(label, id, checked) {
  return `<div class="kv" style="align-items:center">
    <span class="k">${label}</span>
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
      <input id="${id}" type="checkbox" ${checked ? 'checked' : ''} style="accent-color:var(--accent);width:16px;height:16px">
      <span style="font-size:12px;color:var(--text2)">${checked ? 'On' : 'Off'}</span>
    </label>
  </div>`;
}

const MODEL_SPECS = {
  'anthropic/claude-opus-4-5':   { ctx: 200000, out: 32000 },
  'anthropic/claude-sonnet-4-5': { ctx: 200000, out: 16384 },
  'anthropic/claude-sonnet-4-20250514': { ctx: 200000, out: 16384 },
  'anthropic/claude-haiku-3-5':  { ctx: 200000, out: 8192 },
};

function getSelectedModelSpec() {
  const sel = $('cb-model');
  if (!sel) return { ctx: 200000, out: 32000 };
  return MODEL_SPECS[sel.value] || { ctx: 200000, out: 32000 };
}

function updateFlushSliders() {
  updateFlushDisplay();
}

function updateFlushDisplay() {
  const spec = getSelectedModelSpec();
  const pct = parseInt($('cb-flush-slider').value);
  const tokens = Math.round(spec.ctx * pct / 100);
  const reserve = parseInt($('cb-reserve-slider').value);

  $('cb-flush-pct').textContent = pct + '%';
  $('cb-flush-tokens').textContent = tokens.toLocaleString() + ' tokens';
  $('cb-reserve-val').textContent = (reserve / 1000).toFixed(0) + 'K';

  // Context bar visualization
  const sysPct = 10; // ~10% for system prompt + workspace files
  const reservePct = Math.round(reserve / spec.ctx * 100);
  const flushPct = pct;
  const usablePct = flushPct - sysPct;

  const bar = $('ctx-bar');
  if (bar) {
    bar.innerHTML = `
      <div style="position:absolute;left:0;top:0;bottom:0;width:${sysPct}%;background:var(--purple);opacity:.7" title="System prompt"></div>
      <div style="position:absolute;left:${sysPct}%;top:0;bottom:0;width:${usablePct}%;background:var(--green);opacity:.5" title="Usable conversation"></div>
      <div style="position:absolute;left:${flushPct}%;top:0;bottom:0;width:${reservePct}%;background:var(--yellow);opacity:.5" title="Reserve for flush"></div>
      <div style="position:absolute;left:${flushPct + reservePct}%;top:0;bottom:0;right:0;background:var(--red);opacity:.3" title="Hard limit buffer"></div>
      <div style="position:absolute;left:${flushPct}%;top:0;bottom:0;width:2px;background:var(--yellow)" title="Flush trigger"></div>
    `;
  }
  const legend = $('ctx-legend');
  if (legend) {
    const usableK = Math.round((spec.ctx * usablePct / 100) / 1000);
    legend.innerHTML = `<span style="color:var(--purple)">‚ñ†</span> System ~${sysPct}% &nbsp; <span style="color:var(--green)">‚ñ†</span> Usable ~${usableK}K tokens &nbsp; <span style="color:var(--yellow)">‚ñ†</span> Reserve ${(reserve/1000).toFixed(0)}K &nbsp; <span style="color:var(--red)">‚ñ†</span> Buffer`;
  }
}

async function saveClawdbot() {
  const spec = getSelectedModelSpec();
  const flushPct = parseInt($('cb-flush-slider').value);
  const flushTokens = Math.round(spec.ctx * flushPct / 100);
  const reserveTokens = parseInt($('cb-reserve-slider').value);

  const patch = {
    model: {
      primary: $('cb-model').value,
    },
    memorySearch: {
      enabled: $('cb-mem-enabled').checked,
      provider: $('cb-mem-provider').value,
      model: $('cb-mem-model').value,
      fallback: $('cb-mem-fallback').value,
      sources: $('cb-mem-sources').value.split(',').map(s => s.trim()).filter(Boolean),
      remote: {
        baseUrl: $('cb-mem-url').value,
        apiKey: $('cb-mem-apikey').value,
      },
      experimental: {
        sessionMemory: $('cb-mem-session').checked,
      },
      store: { vector: { enabled: $('cb-mem-vector').checked } },
      query: { hybrid: { enabled: $('cb-mem-hybrid').checked } },
      cache: { enabled: $('cb-mem-cache').checked },
      sync: { watch: $('cb-mem-watch').checked },
    },
    compaction: {
      reserveTokensFloor: reserveTokens,
      memoryFlush: {
        enabled: $('cb-comp-flush').checked,
        softThresholdTokens: flushTokens,
        prompt: $('cb-comp-prompt').value,
        systemPrompt: $('cb-comp-sysprompt').value,
      },
    },
  };

  const statusEl = $('cb-save-status');
  statusEl.textContent = 'Saving...';
  statusEl.style.color = 'var(--text2)';
  logOp('Saving Clawdbot config...');

  try {
    const res = await fetch(API + '/api/clawdbot/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(patch),
    });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    statusEl.textContent = '‚úÖ Saved! Restart gateway to apply.';
    statusEl.style.color = 'var(--green)';
    logOp('Clawdbot config saved');
    setTimeout(() => { statusEl.textContent = ''; }, 8000);
  } catch (e) {
    statusEl.textContent = `‚ùå ${e.message}`;
    statusEl.style.color = 'var(--red)';
    logOp(`Clawdbot config error: ${e.message}`);
  }
}

// --- Memory ---
async function loadMemory() {
  try {
    const [memRes, cfgRes] = await Promise.all([
      fetch(API + '/api/memory'),
      fetch(API + '/api/config'),
    ]);
    const d = await memRes.json();
    const cfg = await cfgRes.json();
    const active = cfg.active;

    let html = '<div class="grid grid-2" style="gap:16px">';

    // Left: Pipeline & Config (editable)
    html += '<div>';

    // Pipeline
    html += '<h3 style="margin-bottom:10px">üìä Pipeline</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:8px">Sources ‚Üí Chunking ‚Üí Embedding ‚Üí SQLite</div>';
    for (const s of d.pipeline.sources) {
      html += `<div class="kv"><span class="k">${s.name}</span><span style="font-size:12px;color:var(--text2)">${s.description}</span></div>`;
    }
    html += '</div>';

    // Embedding config (editable)
    html += '<h3 style="margin-bottom:10px">‚öôÔ∏è Embedding Config</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    html += cfgRow('Embed Model', 'cfg-embed-model', active.models.embed, 'text');
    html += cfgRow('Dimensions', 'cfg-embed-dim', active.embedding.dimension, 'number');
    html += cfgRow('Chunk Size', 'cfg-chunk-size', active.embedding.chunkSize, 'number', 'chars');
    html += cfgRow('Chunk Overlap', 'cfg-chunk-overlap', active.embedding.chunkOverlap, 'number', 'chars');
    html += '</div>';

    // Models config (editable)
    html += '<h3 style="margin-bottom:10px">ü§ñ Models</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    html += cfgRow('Triage', 'cfg-model-triage', active.models.triage, 'text');
    html += cfgRow('Code', 'cfg-model-code', active.models.code, 'text');
    html += cfgRow('Reasoning', 'cfg-model-reasoning', active.models.reasoning, 'text');
    html += cfgRow('Embed Fast', 'cfg-model-embed-fast', active.models.embedFast, 'text');
    html += '</div>';

    // Watcher config (editable)
    html += '<h3 style="margin-bottom:10px">üëÅÔ∏è Watcher Config</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    html += `<div class="kv"><span class="k">Daemon</span><span style="font-size:12px">com.localllm.chat-ingest</span></div>`;
    html += cfgRow('File Poll', 'cfg-watch-poll', active.watcher?.pollInterval || 5000, 'number', 'ms');
    html += cfgRow('Debounce', 'cfg-watch-debounce', active.watcher?.debounce || 2000, 'number', 'ms');
    html += cfgRow('New File Scan', 'cfg-watch-scan', active.watcher?.newFileScan || 30000, 'number', 'ms');
    html += '</div>';

    // Thresholds
    html += '<h3 style="margin-bottom:10px">üìè Thresholds</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
    html += cfgRow('Confidence', 'cfg-thresh-confidence', active.thresholds.confidence, 'number');
    html += cfgRow('Urgency', 'cfg-thresh-urgency', active.thresholds.urgency, 'number');
    html += '</div>';

    // Save button
    html += `<div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn" onclick="saveConfig()">üíæ Save Config</button>
      <span id="cfg-save-status" style="font-size:13px;color:var(--text2);align-self:center"></span>
    </div>`;

    html += '</div>';

    // Right: Files (read-only)
    html += '<div>';

    if (d.memoryMd) {
      html += '<h3 style="margin-bottom:10px">üìù MEMORY.md</h3>';
      html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
      html += `<div class="kv"><span class="k">Lines</span><span>${d.memoryMd.lines}</span></div>`;
      html += `<div class="kv"><span class="k">Size</span><span>${fmt(d.memoryMd.sizeBytes)}</span></div>`;
      html += `<div class="kv"><span class="k">Modified</span><span style="font-size:12px">${new Date(d.memoryMd.modified).toLocaleString()}</span></div>`;
      html += '</div>';
    }

    if (d.subdirs.length) {
      html += '<h3 style="margin-bottom:10px">üìÅ Subdirectories</h3>';
      html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:12px">';
      for (const s of d.subdirs) {
        html += `<div class="kv"><span class="k">${s.name}/</span><span>${s.fileCount} files</span></div>`;
      }
      html += '</div>';
    }

    html += '<h3 style="margin-bottom:10px">üìÑ Recent Files</h3>';
    html += '<div style="background:var(--bg3);border-radius:var(--radius);padding:12px;max-height:300px;overflow-y:auto">';
    for (const f of d.files.slice(0, 15)) {
      const date = new Date(f.modified).toLocaleDateString();
      html += `<div class="kv"><span class="k" style="font-size:12px">${f.name}</span><span style="font-size:12px;color:var(--text2)">${fmt(f.sizeBytes)} ¬∑ ${date}</span></div>`;
    }
    html += '</div>';

    html += '</div>';
    html += '</div>';

    $('memory-content').innerHTML = html;
  } catch (e) {
    $('memory-content').innerHTML = `<div class="empty" style="color:var(--red)">${e.message}</div>`;
  }
}

function cfgRow(label, id, value, type, suffix) {
  const sfx = suffix ? `<span style="font-size:12px;color:var(--text2);margin-left:4px">${suffix}</span>` : '';
  const step = type === 'number' && String(value).includes('.') ? 'step="0.1"' : '';
  return `<div class="kv" style="align-items:center">
    <span class="k">${label}</span>
    <div style="display:flex;align-items:center">
      <input id="${id}" type="${type}" value="${value}" ${step}
        style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;color:var(--text);font-size:13px;width:${type==='number'?'100px':'180px'};text-align:right;outline:none"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"
      />${sfx}
    </div>
  </div>`;
}

async function saveConfig() {
  const patch = {
    models: {
      embed: $('cfg-embed-model').value,
      triage: $('cfg-model-triage').value,
      code: $('cfg-model-code').value,
      reasoning: $('cfg-model-reasoning').value,
      embedFast: $('cfg-model-embed-fast').value,
    },
    embedding: {
      dimension: parseInt($('cfg-embed-dim').value),
      chunkSize: parseInt($('cfg-chunk-size').value),
      chunkOverlap: parseInt($('cfg-chunk-overlap').value),
    },
    watcher: {
      pollInterval: parseInt($('cfg-watch-poll').value),
      debounce: parseInt($('cfg-watch-debounce').value),
      newFileScan: parseInt($('cfg-watch-scan').value),
    },
    thresholds: {
      confidence: parseFloat($('cfg-thresh-confidence').value),
      urgency: parseInt($('cfg-thresh-urgency').value),
    },
  };

  const statusEl = $('cfg-save-status');
  statusEl.textContent = 'Saving...';
  statusEl.style.color = 'var(--text2)';
  logOp('Saving config...');

  try {
    const res = await fetch(API + '/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(patch),
    });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    statusEl.textContent = '‚úÖ Saved! Restart daemon to apply watcher changes.';
    statusEl.style.color = 'var(--green)';
    logOp('Config saved to config.local.json');
    setTimeout(() => { statusEl.textContent = ''; }, 5000);
  } catch (e) {
    statusEl.textContent = `‚ùå ${e.message}`;
    statusEl.style.color = 'var(--red)';
    logOp(`Config save error: ${e.message}`);
  }
}

// --- Daemons ---
async function loadDaemons() {
  try {
    const res = await fetch(API + '/api/daemons');
    const daemons = await res.json();
    if (!daemons.length) { $('daemons-content').innerHTML = '<div class="empty">No daemons configured</div>'; return; }
    let html = '';
    for (const d of daemons) {
      const badge = d.running ? 'green' : 'red';
      const status = d.running ? `Running (PID ${d.pid})` : 'Stopped';
      html += `<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
          <span class="status-dot ${d.running ? 'ok' : 'err'}"></span>
          <span style="font-weight:600;font-size:15px">${d.name}</span>
          <span class="badge ${badge}">${status}</span>
          <div style="margin-left:auto;display:flex;gap:6px">
            <button class="btn sm outline" onclick="viewDaemonLogs('${d.label}','out')">üìÑ Stdout</button>
            <button class="btn sm outline" onclick="viewDaemonLogs('${d.label}','err')">‚ö†Ô∏è Stderr</button>
            <button class="btn sm danger" onclick="restartDaemon('${d.label}')">üîÑ Restart</button>
          </div>
        </div>
        <div style="font-size:12px;color:var(--text2)">${d.label}</div>
        <div id="daemon-logs-${d.label.replace(/\./g,'-')}" style="margin-top:8px;display:none;background:var(--bg);border-radius:var(--radius);padding:10px;max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px;line-height:1.6;color:var(--text2)"></div>
      </div>`;
    }
    $('daemons-content').innerHTML = html;
  } catch (e) {
    $('daemons-content').innerHTML = `<div class="empty" style="color:var(--red)">${e.message}</div>`;
  }
}

async function viewDaemonLogs(label, src) {
  const elId = 'daemon-logs-' + label.replace(/\./g, '-');
  const el = $(elId);
  if (el.style.display === 'block' && el.dataset.src === src) { el.style.display = 'none'; return; }
  el.style.display = 'block';
  el.dataset.src = src;
  el.innerHTML = '<span class="loading-text"><span class="spinner"></span> Loading...</span>';
  const srcLabel = src === 'err' ? 'stderr' : 'stdout';
  logOp(`Fetching ${srcLabel} logs for ${label}`);
  try {
    const res = await fetch(`${API}/api/daemons/${encodeURIComponent(label)}/logs?src=${src}&lines=50`);
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    if (!d.lines.length) { el.innerHTML = '<div style="color:var(--text2)">No logs</div>'; return; }
    el.innerHTML = d.lines.map(l => {
      const color = l.src === 'err'
        ? (l.text.includes('[ERROR]') ? 'var(--red)' : 'var(--yellow)')
        : l.text.includes('[chunk]') ? 'var(--green)' : 'var(--text2)';
      return `<div style="color:${color};border-bottom:1px solid rgba(48,54,61,.5);padding:2px 0">${escHtml(l.text)}</div>`;
    }).join('');
    el.scrollTop = el.scrollHeight;
  } catch (e) {
    el.innerHTML = `<div style="color:var(--red)">${e.message}</div>`;
  }
}

async function restartDaemon(label) {
  logOp(`Restarting daemon: ${label}`);
  try {
    const res = await fetch(`${API}/api/daemons/${encodeURIComponent(label)}/restart`, { method: 'POST' });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    logOp(`Daemon restarted: ${label}`);
    setTimeout(loadDaemons, 2000);
  } catch (e) {
    logOp(`Restart error: ${e.message}`);
  }
}

// --- Agent Monitor ---
let _agentSelectedKey = null;
let _agentSelectedKind = null;
let _agentOutputInterval = null;

async function loadAgents() {
  try {
    const res = await fetch(API + '/api/agents');
    const agents = await res.json();
    if (!agents.length) {
      $('agents-content').innerHTML = '<div class="empty">No active agent sessions</div>';
      return;
    }
    const now = Date.now();
    let html = '<table class="agent-table"><thead><tr><th></th><th>Session</th><th>Type</th><th>Model</th><th>Context</th><th>Last Active</th></tr></thead><tbody>';
    for (const a of agents) {
      const age = a.updatedAt ? (now - a.updatedAt) / 1000 : 999;
      const dotClass = age < 120 ? 'active' : age < 300 ? 'idle' : 'stale';
      const selected = (_agentSelectedKey === a.key) ? ' selected' : '';
      const ageText = a.updatedAt ? timeAgo(a.updatedAt) : '‚Äî';
      const ctx = a.percentUsed != null ? a.percentUsed + '%' : '‚Äî';
      const model = escHtml(a.model || '‚Äî');
      const kind = escHtml(a.kind || 'unknown');
      html += '<tr class="clickable' + selected + '" data-key="' + escHtml(a.key) + '" data-kind="' + kind + '">';
      html += '<td><span class="agent-status-dot ' + dotClass + '"></span></td>';
      html += '<td><strong>' + escHtml(a.key) + '</strong></td>';
      html += '<td><span class="badge blue">' + kind + '</span></td>';
      html += '<td>' + model + '</td>';
      html += '<td>' + ctx + '</td>';
      html += '<td>' + ageText + '</td>';
      html += '</tr>';
    }
    html += '</tbody></table>';

    if (_agentSelectedKey) {
      html += '<div id="agent-output-pane" class="agent-output">Loading output...</div>';
      html += '<div class="agent-input-bar"><input type="text" id="agent-input" placeholder="Send command to agent..." /><button onclick="sendAgentInput()">Send</button></div>';
    }

    // NOTE: localhost-only admin dashboard, all data from local shell commands, escHtml for defense in depth
    $('agents-content').innerHTML = html;

    // Bind click handlers
    document.querySelectorAll('.agent-table tr.clickable').forEach(tr => {
      tr.addEventListener('click', () => {
        const key = tr.dataset.key;
        const kind = tr.dataset.kind;
        if (_agentSelectedKey === key) {
          _agentSelectedKey = null;
          _agentSelectedKind = null;
          clearInterval(_agentOutputInterval);
          _agentOutputInterval = null;
        } else {
          _agentSelectedKey = key;
          _agentSelectedKind = kind;
          loadAgentOutput();
          clearInterval(_agentOutputInterval);
          _agentOutputInterval = setInterval(loadAgentOutput, 5000);
        }
        loadAgents();
      });
    });

    if (_agentSelectedKey) loadAgentOutput();
  } catch (e) {
    $('agents-content').textContent = 'Error: ' + e.message;
  }
}

async function loadAgentOutput() {
  const pane = document.getElementById('agent-output-pane');
  if (!pane || !_agentSelectedKey) return;
  try {
    const res = await fetch(API + '/api/agents/' + encodeURIComponent(_agentSelectedKey) + '/log?kind=' + (_agentSelectedKind || 'clawdbot'));
    const d = await res.json();
    if (d.error) { pane.textContent = 'Error: ' + d.error; return; }
    const wasAtBottom = pane.scrollHeight - pane.scrollTop <= pane.clientHeight + 20;
    if (d.type === 'tmux') {
      pane.textContent = (d.lines || []).join('\n');
    } else {
      let text = '';
      for (const msg of (d.messages || [])) {
        const role = (msg.role || '').toUpperCase();
        const content = typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content);
        text += '[' + role + '] ' + content + '\n\n';
      }
      pane.textContent = text || '(no output)';
    }
    if (wasAtBottom) pane.scrollTop = pane.scrollHeight;
  } catch (e) {
    if (pane) pane.textContent = 'Error: ' + e.message;
  }
}

async function sendAgentInput() {
  const input = document.getElementById('agent-input');
  if (!input || !input.value.trim() || !_agentSelectedKey) return;
  const msg = input.value.trim();
  input.value = '';
  try {
    await fetch(API + '/api/agents/' + encodeURIComponent(_agentSelectedKey) + '/send?kind=' + (_agentSelectedKind || 'clawdbot'), {
      method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: msg })
    });
    setTimeout(loadAgentOutput, 1000);
  } catch (e) {
    console.error('Send failed:', e);
  }
}

function timeAgo(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  return Math.floor(s / 86400) + 'd ago';
}

// --- Packages ---
const PKG_ICONS = {
  embeddings: 'üî¢', classifier: 'üè∑Ô∏è', triage: 'üö¶',
  search: 'üîç', transcriber: 'üéôÔ∏è', 'chat-ingest': 'üí¨'
};
const PKG_DESC = {
  embeddings: 'Vector embeddings via Ollama',
  classifier: 'Email classification (rules + LLM)',
  triage: 'Urgency rating & task routing',
  search: 'Semantic search over markdown',
  transcriber: 'Audio transcription (whisper.cpp)',
  'chat-ingest': 'Chat transcript ingestion & search'
};

async function loadPackages() {
  try {
    const res = await fetch(API + '/api/packages');
    const pkgs = await res.json();
    let html = '';
    for (const p of pkgs) {
      const icon = PKG_ICONS[p.name] || 'üì¶';
      html += `<div class="card pkg-card">
        <div class="pkg-header">
          <span style="font-size:20px">${icon}</span>
          <span class="pkg-name">${p.name}</span>
          <span class="badge ${p.exists ? 'green' : 'red'}">${p.exists ? 'OK' : 'Missing'}</span>
        </div>
        <div style="font-size:12px;color:var(--text2)">${PKG_DESC[p.name] || ''}</div>
        ${p.version ? `<div style="font-size:11px;color:var(--text2)">v${p.version}</div>` : ''}
      </div>`;
    }
    $('packages-grid').innerHTML = html;
  } catch (e) {
    $('packages-grid').innerHTML = `<div class="empty" style="color:var(--red)">${e.message}</div>`;
  }
}

// --- Model Manager ---
// NOTE: This is a localhost-only admin dashboard (no external users).
// All data rendered via innerHTML comes from local Ollama API and local files only.
// escHtml() is applied to all dynamic text for defense-in-depth against any future data source changes.
async function loadModelManager() {
  try {
    const res = await fetch(API + '/api/models/available');
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    const models = d.models || [];

    let html = '';
    html += '<div style="display:flex;gap:8px;margin-bottom:12px">';
    html += '<input type="text" id="mm-pull-name" placeholder="Model name to pull (e.g. llama3:8b)" style="flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px;color:var(--text);font-size:13px;outline:none" />';
    html += '<button class="btn" onclick="mmPull()">Pull</button>';
    html += '</div>';
    html += '<div id="mm-status" style="font-size:13px;color:var(--text2);margin-bottom:8px;display:none"></div>';

    if (!models.length) {
      html += '<div class="empty">No models found in Ollama</div>';
    } else {
      html += '<table class="mm-table"><thead><tr><th>Model</th><th>Size</th><th>Family</th><th>Quant</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
      for (const m of models) {
        const sizeGB = (m.size / 1073741824).toFixed(1);
        const badge = m.loaded ? '<span class="badge green">Loaded</span>' : '<span class="badge yellow">Cold</span>';
        html += '<tr>';
        html += '<td><strong>' + escHtml(m.name) + '</strong></td>';
        html += '<td>' + sizeGB + ' GB</td>';
        html += '<td>' + escHtml(m.family || '\u2014') + '</td>';
        html += '<td>' + escHtml(m.quantization || '\u2014') + '</td>';
        html += '<td>' + badge + '</td>';
        html += '<td class="actions">';
        if (!m.loaded) {
          html += '<button class="btn sm outline" onclick="mmWarm(\'' + escHtml(m.name) + '\')">Warm</button>';
        } else {
          html += '<button class="btn sm outline" onclick="mmUnload(\'' + escHtml(m.name) + '\')">Unload</button>';
        }
        html += '<button class="btn sm danger" onclick="mmDelete(\'' + escHtml(m.name) + '\')">Delete</button>';
        html += '</td></tr>';
      }
      html += '</tbody></table>';
    }

    // Safety: localhost-only admin tool, all data from local Ollama, escHtml for defense in depth
    $('model-mgr-content').innerHTML = html;
  } catch (e) {
    $('model-mgr-content').textContent = 'Error: ' + e.message;
  }
}

function mmShowStatus(msg, color) {
  const el = $('mm-status');
  if (!el) return;
  el.textContent = msg;
  el.style.color = color || 'var(--text2)';
  el.style.display = 'block';
}

async function mmPull() {
  const name = $('mm-pull-name').value.trim();
  if (!name) return;
  mmShowStatus('Pulling ' + name + '... (this may take a while)', 'var(--accent)');
  logOp('Pulling model: ' + name);
  try {
    const res = await fetch(API + '/api/models/pull', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name}) });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    mmShowStatus('Pulled ' + name + ' successfully', 'var(--green)');
    logOp('Model pulled: ' + name);
    loadModelManager();
    loadBudget();
  } catch (e) {
    mmShowStatus('Pull failed: ' + e.message, 'var(--red)');
    logOp('Pull error: ' + e.message);
  }
}

async function mmWarm(name) {
  mmShowStatus('Warming ' + name + '...', 'var(--accent)');
  logOp('Warming model: ' + name);
  try {
    const res = await fetch(API + '/api/models/warm', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name}) });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    mmShowStatus(name + ' loaded into memory', 'var(--green)');
    logOp('Model warmed: ' + name);
    loadModelManager();
    loadBudget();
  } catch (e) {
    mmShowStatus('Warm failed: ' + e.message, 'var(--red)');
  }
}

async function mmUnload(name) {
  mmShowStatus('Unloading ' + name + '...', 'var(--accent)');
  logOp('Unloading model: ' + name);
  try {
    const res = await fetch(API + '/api/models/warm', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name, keep_alive: '0'}) });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    mmShowStatus(name + ' unloaded from memory', 'var(--green)');
    logOp('Model unloaded: ' + name);
    loadModelManager();
    loadBudget();
  } catch (e) {
    mmShowStatus('Unload failed: ' + e.message, 'var(--red)');
  }
}

async function mmDelete(name) {
  if (!confirm('Delete model "' + name + '"? This cannot be undone.')) return;
  mmShowStatus('Deleting ' + name + '...', 'var(--red)');
  logOp('Deleting model: ' + name);
  try {
    const res = await fetch(API + '/api/models/delete', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name}) });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    mmShowStatus(name + ' deleted', 'var(--green)');
    logOp('Model deleted: ' + name);
    loadModelManager();
    loadBudget();
  } catch (e) {
    mmShowStatus('Delete failed: ' + e.message, 'var(--red)');
  }
}

// --- Model Budget Visualizer ---
async function loadBudget() {
  try {
    const res = await fetch(API + '/api/budget');
    const d = await res.json();
    if (d.error) throw new Error(d.error);

    const totalGB = d.totalRam / 1073741824;
    const osGB = d.osOverhead / 1073741824;
    const freeGB = d.freeHeadroom / 1073741824;

    const osPct = (d.osOverhead / d.totalRam * 100).toFixed(1);
    const freePct = (d.freeHeadroom / d.totalRam * 100).toFixed(1);

    const parts = [];

    // Build bar segments
    parts.push('<div class="budget-bar">');
    parts.push('<div class="budget-seg" style="width:' + osPct + '%;background:var(--red);opacity:.7">' + (osPct > 8 ? osGB.toFixed(1) + 'G' : '') + '</div>');

    const loaded = (d.models || []).filter(m => m.loaded);
    const cold = (d.models || []).filter(m => !m.loaded);
    const modelColors = ['var(--accent)', 'var(--purple)', 'var(--green)', 'var(--orange)', 'var(--yellow)'];
    let ci = 0;
    for (const m of loaded) {
      const mPct = (m.size / d.totalRam * 100).toFixed(1);
      const color = modelColors[ci++ % modelColors.length];
      const label = mPct > 5 ? escHtml(m.name.split(':')[0]) : '';
      parts.push('<div class="budget-seg" style="width:' + mPct + '%;background:' + color + ';opacity:.8">' + label + '</div>');
    }

    parts.push('<div class="budget-seg" style="width:' + freePct + '%;background:var(--bg);border:1px dashed var(--border)">');
    parts.push('<span style="color:var(--text2)">' + freeGB.toFixed(1) + 'G free</span></div>');
    parts.push('</div>');

    // Legend
    parts.push('<div class="budget-legend">');
    parts.push('<span><span class="swatch" style="background:var(--red);opacity:.7"></span> OS ~' + osGB.toFixed(0) + 'GB</span>');
    ci = 0;
    for (const m of loaded) {
      const color = modelColors[ci++ % modelColors.length];
      parts.push('<span><span class="swatch" style="background:' + color + ';opacity:.8"></span> ' + escHtml(m.name) + ' ' + (m.size / 1073741824).toFixed(1) + 'GB</span>');
    }
    parts.push('<span><span class="swatch" style="background:var(--bg);border:1px dashed var(--border)"></span> Free ' + freeGB.toFixed(1) + 'GB</span>');
    parts.push('</div>');

    // Summary stats
    parts.push('<div style="display:flex;gap:24px;margin-top:12px">');
    parts.push('<div class="stat"><span class="label">Total RAM</span><span class="value sm">' + totalGB.toFixed(0) + ' GB</span></div>');
    parts.push('<div class="stat"><span class="label">Models Loaded</span><span class="value sm">' + loaded.length + '</span></div>');
    parts.push('<div class="stat"><span class="label">Models Available</span><span class="value sm">' + (d.models || []).length + '</span></div>');
    parts.push('<div class="stat"><span class="label">Headroom</span><span class="value sm" style="color:' + (freeGB < 5 ? 'var(--red)' : freeGB < 10 ? 'var(--yellow)' : 'var(--green)') + '">' + freeGB.toFixed(1) + ' GB</span></div>');
    parts.push('</div>');

    if (cold.length) {
      parts.push('<div style="margin-top:12px;font-size:12px;color:var(--text2)">Cold models: ');
      parts.push(cold.map(m => escHtml(m.name) + ' (' + (m.size / 1073741824).toFixed(1) + 'G)').join(', '));
      parts.push('</div>');
    }

    // Safety: localhost-only admin tool, data from local Ollama API, escHtml for defense in depth
    $('budget-content').innerHTML = parts.join('');
  } catch (e) {
    $('budget-content').textContent = 'Error: ' + e.message;
  }
}

// --- Route Switcher ---
async function loadRoutes() {
  try {
    const res = await fetch(API + '/api/routes/config');
    const d = await res.json();
    const tiers = d.tiers || [];

    const parts = [];

    // 5-tier table
    parts.push('<table class="tier-table"><thead><tr><th>Tier</th><th>Model</th><th>Role</th><th>Best Use Case</th><th>Cost</th></tr></thead><tbody>');
    const tierColors = { S1: 'purple', S2: 'orange', A: 'blue', B: 'green', C: 'yellow' };
    for (const t of tiers) {
      parts.push('<tr>');
      parts.push('<td><span class="badge ' + (tierColors[t.tier] || 'blue') + '">' + escHtml(t.tier) + '</span></td>');
      parts.push('<td><strong>' + escHtml(t.model) + '</strong></td>');
      parts.push('<td>' + escHtml(t.role) + '</td>');
      parts.push('<td style="font-size:12px;color:var(--text2)">' + escHtml(t.use) + '</td>');
      parts.push('<td>' + escHtml(t.cost) + '</td>');
      parts.push('</tr>');
    }
    parts.push('</tbody></table>');

    parts.push('<div style="font-size:12px;color:var(--text2);margin-bottom:12px">Router model: <span class="badge blue">' + escHtml(d.routerModel || '?') + '</span></div>');

    // Test panel
    parts.push('<h3 style="margin-bottom:8px">Test Routing</h3>');
    parts.push('<div style="display:flex;gap:8px;margin-bottom:8px">');
    parts.push('<input type="text" id="route-test-input" placeholder="Type a prompt to test routing..." style="flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px;color:var(--text);font-size:13px;outline:none" />');
    parts.push('<button class="btn" onclick="testRoute()">Route</button>');
    parts.push('</div>');
    parts.push('<div id="route-test-result" style="display:none;background:var(--bg3);border-radius:var(--radius);padding:12px;font-family:monospace;font-size:13px"></div>');

    // Safety: localhost-only admin tool, data from local config, escHtml for defense in depth
    $('routes-content').innerHTML = parts.join('');

    const inp = $('route-test-input');
    if (inp) inp.addEventListener('keydown', e => { if (e.key === 'Enter') testRoute(); });
  } catch (e) {
    $('routes-content').textContent = 'Error: ' + e.message;
  }
}

async function testRoute() {
  const prompt = $('route-test-input').value.trim();
  if (!prompt) return;
  const el = $('route-test-result');
  el.style.display = 'block';
  el.textContent = 'Routing...';
  logOp('Testing route for: "' + prompt.slice(0, 50) + '..."');
  try {
    const res = await fetch(API + '/api/routes/test', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({prompt}) });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    const routeColors = { gemini_3_pro: 'purple', claude_opus: 'orange', claude_sonnet: 'blue', claude_haiku: 'green', local_qwen: 'yellow' };
    const color = routeColors[d.route] || 'blue';
    // Safety: localhost-only admin tool, result from local Ollama triage model, escHtml for defense in depth
    el.innerHTML = '<div style="margin-bottom:8px"><span class="badge ' + color + '" style="font-size:14px;padding:4px 12px">' + escHtml(d.route) + '</span> <span class="badge ' + (d.priority === 'high' ? 'red' : d.priority === 'low' ? 'green' : 'yellow') + '">' + escHtml(d.priority) + '</span></div>' +
      '<div style="color:var(--text2)">' + escHtml(d.reason) + '</div>';
    logOp('Route result: ' + d.route + ' (' + d.priority + ')');
  } catch (e) {
    el.textContent = 'Error: ' + e.message;
    logOp('Route test error: ' + e.message);
  }
}

// --- RAG Inspector ---
let _ragOffset = 0;
let _ragSource = 'memory';

async function loadRag() {
  try {
    const [chunksRes, cfgRes] = await Promise.all([
      fetch(API + '/api/rag/chunks?source=' + _ragSource + '&offset=' + _ragOffset + '&limit=20'),
      fetch(API + '/api/rag/config'),
    ]);
    const chunks = await chunksRes.json();
    const cfg = await cfgRes.json();

    const parts = [];

    // Config display
    parts.push('<div style="display:flex;gap:16px;margin-bottom:12px;flex-wrap:wrap;align-items:center">');
    parts.push('<div style="font-size:13px"><span style="color:var(--text2)">Chunk Size:</span> <strong>' + cfg.chunkSize + '</strong> chars</div>');
    parts.push('<div style="font-size:13px"><span style="color:var(--text2)">Overlap:</span> <strong>' + cfg.chunkOverlap + '</strong> chars</div>');
    parts.push('<div style="font-size:13px"><span style="color:var(--text2)">Dimensions:</span> <strong>' + cfg.dimension + '</strong></div>');
    parts.push('<div style="font-size:13px"><span style="color:var(--text2)">Model:</span> <span class="badge blue">' + escHtml(cfg.model) + '</span></div>');
    parts.push('</div>');

    // Source selector + controls
    parts.push('<div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">');
    parts.push('<select id="rag-source" onchange="ragChangeSource(this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:6px 10px;color:var(--text);font-size:13px">');
    parts.push('<option value="memory"' + (_ragSource === 'memory' ? ' selected' : '') + '>Memory Chunks</option>');
    parts.push('<option value="chat"' + (_ragSource === 'chat' ? ' selected' : '') + '>Chat Chunks</option>');
    parts.push('</select>');
    parts.push('<span style="font-size:13px;color:var(--text2)">' + (chunks.total || 0).toLocaleString() + ' total chunks</span>');
    parts.push('<div style="margin-left:auto;display:flex;gap:6px">');
    parts.push('<button class="btn sm outline" onclick="ragReindex()">Reindex</button>');
    parts.push('<button class="btn sm outline" onclick="loadRag()">Refresh</button>');
    parts.push('</div>');
    parts.push('</div>');

    // Chunk list
    parts.push('<div id="rag-chunks" style="max-height:500px;overflow-y:auto">');
    if (!chunks.chunks || !chunks.chunks.length) {
      parts.push('<div class="empty">No chunks found</div>');
    } else {
      for (const c of chunks.chunks) {
        parts.push('<div class="rag-chunk">');
        parts.push('<div class="rag-meta">');
        parts.push('<span class="badge blue">#' + c.id + '</span>');
        if (c.file) parts.push('<span>' + escHtml(c.file) + '</span>');
        if (c.start_line != null) parts.push('<span>L' + c.start_line + '-' + c.end_line + '</span>');
        if (c.session_id) parts.push('<span>session:' + escHtml(c.session_id.slice(0, 8)) + '</span>');
        if (c.start_ts) parts.push('<span>' + escHtml(c.start_ts) + '</span>');
        const textLen = (c.text || '').length;
        parts.push('<span>' + textLen + ' chars</span>');
        parts.push('</div>');
        const preview = (c.text || '').slice(0, 200);
        parts.push('<div class="rag-text" onclick="this.classList.toggle(\'expanded\')">' + escHtml(preview) + (textLen > 200 ? '...' : '') + '</div>');
        parts.push('</div>');
      }
    }
    parts.push('</div>');

    // Pagination
    if (chunks.total > 20) {
      parts.push('<div style="display:flex;gap:8px;margin-top:8px;justify-content:center">');
      if (_ragOffset > 0) parts.push('<button class="btn sm outline" onclick="ragPage(-1)">Prev</button>');
      parts.push('<span style="font-size:12px;color:var(--text2);align-self:center">' + (_ragOffset + 1) + '-' + Math.min(_ragOffset + 20, chunks.total) + ' of ' + chunks.total + '</span>');
      if (_ragOffset + 20 < chunks.total) parts.push('<button class="btn sm outline" onclick="ragPage(1)">Next</button>');
      parts.push('</div>');
    }

    // Safety: localhost-only admin tool, chunk data from local SQLite, escHtml for defense in depth
    $('rag-content').innerHTML = parts.join('');
  } catch (e) {
    $('rag-content').textContent = 'Error: ' + e.message;
  }
}

function ragChangeSource(source) {
  _ragSource = source;
  _ragOffset = 0;
  loadRag();
}

function ragPage(dir) {
  _ragOffset = Math.max(0, _ragOffset + dir * 20);
  loadRag();
}

async function ragReindex() {
  logOp('RAG reindex started...');
  try {
    const res = await fetch(API + '/api/rag/reindex', { method: 'POST' });
    const d = await res.json();
    if (d.error) throw new Error(d.error);
    logOp('RAG reindex triggered: ' + d.source);
  } catch (e) {
    logOp('RAG reindex error: ' + e.message);
  }
}

// --- Token Economics ---
async function loadEconomics() {
  try {
    const res = await fetch(API + '/api/economics');
    const d = await res.json();
    if (d.error) throw new Error(d.error);

    const models = Object.entries(d.models || {});
    if (!models.length) {
      $('economics-content').textContent = 'No token usage data yet';
      return;
    }

    const parts = [];

    let totalInput = 0, totalOutput = 0;
    for (const [, s] of models) { totalInput += s.inputTokens; totalOutput += s.outputTokens; }

    parts.push('<div style="display:flex;gap:24px;margin-bottom:16px;flex-wrap:wrap">');
    parts.push('<div class="stat"><span class="label">Sessions</span><span class="value sm">' + (d.sessions || 0) + '</span></div>');
    parts.push('<div class="stat"><span class="label">Total Input</span><span class="value sm">' + (totalInput / 1000000).toFixed(2) + 'M</span></div>');
    parts.push('<div class="stat"><span class="label">Total Output</span><span class="value sm">' + (totalOutput / 1000000).toFixed(2) + 'M</span></div>');
    parts.push('<div class="stat"><span class="label">Est. API Cost</span><span class="value sm" style="color:var(--red)">$' + (d.totalEstimatedCost || 0).toFixed(2) + '</span></div>');
    parts.push('<div class="stat"><span class="label">Actual Cost</span><span class="value sm" style="color:var(--green)">$0 (Max)</span></div>');
    parts.push('</div>');

    // Per-model table
    parts.push('<table class="mm-table"><thead><tr><th>Model</th><th>Messages</th><th>Input Tokens</th><th>Output Tokens</th><th>Est. API Cost</th></tr></thead><tbody>');
    const sorted = models.sort((a, b) => (b[1].inputTokens + b[1].outputTokens) - (a[1].inputTokens + a[1].outputTokens));
    for (const [model, stats] of sorted) {
      parts.push('<tr>');
      parts.push('<td><strong>' + escHtml(model) + '</strong></td>');
      parts.push('<td>' + stats.messageCount.toLocaleString() + '</td>');
      parts.push('<td>' + stats.inputTokens.toLocaleString() + '</td>');
      parts.push('<td>' + stats.outputTokens.toLocaleString() + '</td>');
      parts.push('<td>' + (stats.estimatedCost != null ? '$' + stats.estimatedCost.toFixed(2) : '\u2014') + '</td>');
      parts.push('</tr>');
    }
    parts.push('</tbody></table>');

    parts.push('<div style="margin-top:8px;font-size:12px;color:var(--text2)">' + escHtml(d.note || '') + '</div>');

    // Safety: localhost-only admin tool, token data from local JSONL files, escHtml for defense in depth
    $('economics-content').innerHTML = parts.join('');
  } catch (e) {
    $('economics-content').textContent = 'Error: ' + e.message;
  }
}

// --- WebSocket ---
function connectWs() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(`${proto}//${location.host}`);
  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'status') {
        const dot = $('ollama-dot');
        const lbl = $('ollama-label');
        if (msg.ollama.healthy) { dot.className = 'status-dot ok'; lbl.textContent = 'Ollama Online'; }
        else { dot.className = 'status-dot err'; lbl.textContent = 'Ollama Offline'; }
        if (msg.timestamp) $('last-update').textContent = 'Updated ' + new Date(msg.timestamp).toLocaleTimeString();
        // Update models from WS
        if (msg.models?.length) {
          let html = '';
          for (const m of msg.models) {
            html += `<div class="model-row"><span class="name">${m.name}</span><span class="size">${fmtModelSize(m.size)}</span><span class="badge blue">${m.details?.family || '‚Äî'}</span></div>`;
          }
          $('models-content').innerHTML = html;
        }
      }
      if (msg.type === 'agents') {
        // Live agent updates via WebSocket - refresh the agent list
        loadAgents();
      }
    } catch {}
  };
  ws.onclose = () => setTimeout(connectWs, 5000);
  ws.onerror = () => ws.close();
}

// --- Prompt Editor ---
// Safety: This is a localhost-only admin dashboard. All user-controlled text
// is passed through escHtml() before innerHTML insertion. No external/untrusted
// content is rendered. See CLAUDE.md "Dashboard security hook" for rationale.
let _peCurrentFile = null;

async function loadPromptEditor() {
  try {
    const res = await fetch(API + '/api/workspace/files');
    const files = await res.json();
    let html = '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap;">';
    html += '<select class="pe-select" id="pe-file-select" onchange="loadWorkspaceFile(this.value)">';
    html += '<option value="">Select a file...</option>';
    for (const f of files) {
      const sizeKB = (f.sizeBytes / 1024).toFixed(1);
      const status = f.exists ? sizeKB + ' KB' : 'missing';
      html += '<option value="' + escHtml(f.name) + '"' + (f.exists ? '' : ' disabled') + '>' + escHtml(f.name) + ' (' + status + ')</option>';
    }
    html += '</select>';
    html += '<span id="pe-file-info" style="font-size:12px;color:var(--text2)"></span>';
    html += '</div>';
    html += '<textarea class="pe-textarea" id="pe-editor" placeholder="Select a file to edit..." disabled></textarea>';
    html += '<div class="pe-bar">';
    html += '<span class="pe-stats" id="pe-stats"></span>';
    html += '<button class="btn" id="pe-save-btn" onclick="saveWorkspaceFile()" disabled>Save</button>';
    html += '</div>';
    // Safety: all dynamic values above are escaped via escHtml(); localhost-only admin tool
    $('prompt-editor-content').innerHTML = html;

    const editor = $('pe-editor');
    editor.addEventListener('input', () => {
      const chars = editor.value.length;
      const estTokens = Math.round(chars / 4);
      $('pe-stats').textContent = chars.toLocaleString() + ' chars ¬∑ ~' + estTokens.toLocaleString() + ' tokens';
    });
  } catch (e) {
    $('prompt-editor-content').textContent = 'Error: ' + e.message;
  }
}

async function loadWorkspaceFile(name) {
  if (!name) return;
  const editor = $('pe-editor');
  const info = $('pe-file-info');
  editor.value = 'Loading...';
  editor.disabled = true;
  try {
    const res = await fetch(API + '/api/workspace/file?path=' + encodeURIComponent(name));
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    _peCurrentFile = name;
    editor.value = data.content;
    editor.disabled = false;
    $('pe-save-btn').disabled = false;
    info.textContent = 'Last modified: ' + new Date(data.modified).toLocaleString();
    editor.dispatchEvent(new Event('input'));
  } catch (e) {
    editor.value = 'Error loading file: ' + e.message;
    info.textContent = '';
  }
}

async function saveWorkspaceFile() {
  if (!_peCurrentFile) return;
  const editor = $('pe-editor');
  const btn = $('pe-save-btn');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  try {
    const res = await fetch(API + '/api/workspace/file', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: _peCurrentFile, content: editor.value }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    btn.textContent = 'Saved!';
    $('pe-file-info').textContent = 'Saved ¬∑ ' + (data.sizeBytes / 1024).toFixed(1) + ' KB';
    setTimeout(() => { btn.textContent = 'Save'; btn.disabled = false; }, 2000);
  } catch (e) {
    btn.textContent = 'Error!';
    $('pe-file-info').textContent = 'Save failed: ' + e.message;
    setTimeout(() => { btn.textContent = 'Save'; btn.disabled = false; }, 2000);
  }
}

// --- Skills Manager ---
async function loadSkills() {
  try {
    const res = await fetch(API + '/api/skills');
    const skills = await res.json();
    if (!skills.length) { $('skills-content').textContent = 'No skills found'; return; }

    const customCount = skills.filter(s => s.type === 'custom').length;
    const builtinCount = skills.filter(s => s.type === 'built-in').length;
    let html = '<div style="margin-bottom:12px;font-size:13px;color:var(--text2)">' + skills.length + ' skills (' + customCount + ' custom, ' + builtinCount + ' built-in)</div>';
    html += '<div class="skills-grid">';
    for (const skill of skills) {
      const badgeClass = skill.type === 'custom' ? 'purple' : 'blue';
      html += '<div class="skill-card" onclick="toggleSkillDetail(this, \'' + escHtml(skill.name) + '\')">';
      html += '<div class="skill-header"><span class="skill-name">' + escHtml(skill.name) + '</span><span class="badge ' + badgeClass + '">' + escHtml(skill.type) + '</span></div>';
      html += '<div class="skill-desc">' + (skill.description ? escHtml(skill.description) : '<em style="color:var(--text2)">No description</em>') + '</div>';
      if (skill.hasSkillMd) html += '<div class="skill-detail" id="skill-detail-' + escHtml(skill.name) + '"></div>';
      html += '</div>';
    }
    html += '</div>';
    // Safety: all dynamic values escaped via escHtml(); localhost-only admin tool
    $('skills-content').innerHTML = html;
  } catch (e) {
    $('skills-content').textContent = 'Error: ' + e.message;
  }
}

async function toggleSkillDetail(card, name) {
  const detail = card.querySelector('.skill-detail');
  if (!detail) return;
  if (detail.style.display === 'block') { detail.style.display = 'none'; return; }
  if (!detail.textContent) {
    detail.textContent = 'Loading...';
    detail.style.display = 'block';
    try {
      const res = await fetch(API + '/api/skills/' + encodeURIComponent(name));
      const data = await res.json();
      detail.textContent = data.content || 'Empty';
    } catch (e) {
      detail.textContent = 'Error: ' + e.message;
    }
  } else {
    detail.style.display = 'block';
  }
}

// --- Corrections Viewer ---
async function loadCorrections() {
  try {
    const res = await fetch(API + '/api/corrections');
    const corrections = await res.json();
    if (!corrections.length) { $('corrections-content').textContent = 'No corrections found'; return; }

    const dateCounts = {};
    for (const c of corrections) {
      const dateMatch = c.name.match(/^(\d{4}-\d{2}-\d{2})/);
      if (dateMatch) { dateCounts[dateMatch[1]] = (dateCounts[dateMatch[1]] || 0) + 1; }
    }

    let html = '<div style="margin-bottom:12px;font-size:13px;color:var(--text2)">' + corrections.length + ' correction files</div>';
    for (const c of corrections) {
      const dateMatch = c.name.match(/^(\d{4}-\d{2}-\d{2})/);
      const dateStr = dateMatch ? dateMatch[1] : '';
      const count = dateCounts[dateStr] || 0;
      html += '<div class="correction-item" onclick="toggleCorrection(this, \'' + escHtml(c.name) + '\')">';
      html += '<div class="corr-header">';
      html += '<span class="corr-name">' + escHtml(c.name) + '</span>';
      if (count > 1) html += '<span class="badge yellow">' + count + '/day</span>';
      html += '<span style="font-size:12px;color:var(--text2)">' + (c.sizeBytes / 1024).toFixed(1) + ' KB</span>';
      html += '</div>';
      html += '<div class="corr-body" id="corr-' + escHtml(c.name) + '"></div>';
      html += '</div>';
    }
    // Safety: all dynamic values escaped via escHtml(); localhost-only admin tool
    $('corrections-content').innerHTML = html;
  } catch (e) {
    $('corrections-content').textContent = 'Error: ' + e.message;
  }
}

async function toggleCorrection(el, name) {
  const body = el.querySelector('.corr-body');
  if (!body) return;
  if (body.style.display === 'block') { body.style.display = 'none'; return; }
  if (!body.textContent) {
    body.textContent = 'Loading...';
    body.style.display = 'block';
    try {
      const res = await fetch(API + '/api/corrections/' + encodeURIComponent(name));
      const data = await res.json();
      body.textContent = data.content || 'Empty';
    } catch (e) {
      body.textContent = 'Error: ' + e.message;
    }
  } else {
    body.style.display = 'block';
  }
}

// --- Session Manager ---
async function loadSessionManager() {
  try {
    const res = await fetch(API + '/api/sessions/list');
    const sessions = await res.json();
    if (!sessions.length) { $('sessions-content').textContent = 'No sessions found'; return; }

    let html = '<div style="margin-bottom:8px;font-size:13px;color:var(--text2)">' + sessions.length + ' sessions</div>';
    html += '<div style="max-height:400px;overflow-y:auto">';
    html += '<table class="sess-table"><thead><tr><th>Session ID</th><th>Size</th><th>Est. Messages</th><th>Last Modified</th></tr></thead><tbody>';
    for (const s of sessions) {
      const sizeMB = (s.sizeBytes / (1024 * 1024)).toFixed(2);
      const shortId = s.sessionId.length > 20 ? s.sessionId.slice(0, 8) + '...' + s.sessionId.slice(-8) : s.sessionId;
      const modified = new Date(s.lastModified).toLocaleString();
      html += '<tr><td class="sess-id"><span class="clickable" title="' + escHtml(s.sessionId) + '" onclick="openSessionInChat(\'' + escHtml(s.sessionId) + '\')">' + escHtml(shortId) + '</span></td>';
      html += '<td>' + sizeMB + ' MB</td>';
      html += '<td>' + s.estimatedMessages.toLocaleString() + '</td>';
      html += '<td>' + escHtml(modified) + '</td></tr>';
    }
    html += '</tbody></table></div>';
    // Safety: all dynamic values escaped via escHtml(); localhost-only admin tool
    $('sessions-content').innerHTML = html;
  } catch (e) {
    $('sessions-content').textContent = 'Error: ' + e.message;
  }
}

function openSessionInChat(sessionId) {
  const chatCard = $('chat-card');
  if (chatCard) chatCard.scrollIntoView({ behavior: 'smooth' });
  const sel = $('chat-session-select');
  if (sel) {
    sel.value = sessionId;
    sel.dispatchEvent(new Event('change'));
  }
}

// --- Cron Manager ---
async function loadCron() {
  try {
    const res = await fetch(API + '/api/cron/list');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    const jobs = Array.isArray(data) ? data : [];
    if (!jobs.length) {
      $('cron-content').textContent = 'No cron jobs found';
      return;
    }

    let html = '<table class="cron-table"><thead><tr><th>ID</th><th>Schedule</th><th>Text</th><th>Enabled</th><th>Action</th></tr></thead><tbody>';
    for (const job of jobs) {
      const id = job.id || job.name || '?';
      const schedule = job.schedule || job.cron || job.interval || '\u2014';
      const text = job.text || job.command || job.description || '\u2014';
      const enabled = job.enabled !== false;
      html += '<tr>';
      html += '<td style="font-family:monospace;font-size:12px">' + escHtml(String(id)) + '</td>';
      html += '<td><code style="font-size:12px">' + escHtml(String(schedule)) + '</code></td>';
      html += '<td>' + escHtml(String(text).slice(0, 100)) + '</td>';
      html += '<td><span class="badge ' + (enabled ? 'green' : 'red') + '">' + (enabled ? 'yes' : 'no') + '</span></td>';
      html += '<td><button class="btn sm" onclick="runCronJob(\'' + escHtml(String(id)) + '\')">Run</button></td>';
      html += '</tr>';
    }
    html += '</tbody></table>';
    // Safety: all dynamic values escaped via escHtml(); localhost-only admin tool
    $('cron-content').innerHTML = html;
  } catch (e) {
    $('cron-content').textContent = 'Clawdbot CLI not available or no cron jobs configured';
  }
}

async function runCronJob(id) {
  try {
    const res = await fetch(API + '/api/cron/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    alert('Cron job triggered: ' + (data.output || 'OK'));
  } catch (e) {
    alert('Failed to run cron job: ' + e.message);
  }
}

// --- Alerts ---
async function loadAlerts() {
  try {
    const res = await fetch(API + '/api/alerts');
    const alerts = await res.json();
    if (!alerts.length) { $('alerts-content').textContent = 'No alerts'; return; }

    const order = { red: 0, yellow: 1, green: 2 };
    alerts.sort((a, b) => (order[a.severity] ?? 3) - (order[b.severity] ?? 3));

    let html = '';
    for (const a of alerts) {
      html += '<div class="alert-item">';
      html += '<span class="alert-dot ' + escHtml(a.severity) + '"></span>';
      html += '<span class="alert-title">' + escHtml(a.title) + '</span>';
      html += '<span class="alert-detail">' + escHtml(a.detail) + '</span>';
      html += '</div>';
    }
    // Safety: all dynamic values escaped via escHtml(); localhost-only admin tool
    $('alerts-content').innerHTML = html;
  } catch (e) {
    $('alerts-content').textContent = 'Error: ' + e.message;
  }
}

// --- Init ---
(async () => {
  await Promise.all([loadStatus(), loadModels(), loadJobs(), loadContextMonitor(), loadAgents(), loadChatSessions(), loadClawdbot(), loadMemory(), loadDaemons(), loadPackages(), loadModelManager(), loadBudget(), loadRoutes(), loadRag(), loadEconomics(), loadPromptEditor(), loadSkills(), loadCorrections(), loadSessionManager(), loadCron(), loadAlerts()]);
  connectWs();
  // Refresh context monitor every 30s
  setInterval(loadContextMonitor, 30000);
  // Refresh agent list every 10s
  setInterval(loadAgents, 10000);
  // Refresh full status every 60s
  setInterval(() => { loadStatus(); loadJobs(); loadDaemons(); loadAlerts(); }, 60000);
  // Refresh model manager and budget every 30s
  setInterval(() => { loadModelManager(); loadBudget(); }, 30000);
  // Refresh economics every 120s
  setInterval(loadEconomics, 120000);
})();
</script>
</body>
</html>
